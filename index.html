<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gocoin - Bitcoin Full Node in Go</title>
    <link rel="icon" type="image/x-icon" href="favicon.ico">
    <link rel="stylesheet" href="style.css">
    <style>
        /* Additional styles for iframe mode */
        .content-frame {
            display: none;
            width: 100%;
            height: 100%;
            min-height: 100vh;
            border: none;
            background: white;
        }
        
        .content-frame.active {
            display: block;
        }
        
        /* Adjust for iframe mode - add padding like server mode */
        body.iframe-mode {
            background: white !important; /* Make body white */
        }
        
        body.iframe-mode .main-content {
            min-height: 100vh;
            background: white !important; /* Remove the darker background */
        }
        
        body.iframe-mode .content-wrapper {
            padding: 40px 60px;
            min-height: 100vh;
            background: white !important; /* Match iframe background */
            box-shadow: none !important; /* Remove shadow to blend in */
        }
        
        body.iframe-mode .content-frame {
            background: white !important; /* Make iframe background white */
        }
        
        /* Inject white background into iframe content */
        body.iframe-mode .content-frame {
            background: white !important;
        }
        
        /* Responsive padding for iframe mode */
        @media (max-width: 1024px) {
            body.iframe-mode .content-wrapper {
                padding: 30px 40px;
            }
        }
        
        @media (max-width: 768px) {
            body.iframe-mode .content-wrapper {
                padding: 80px 20px 30px;
            }
        }
        
        @media (max-width: 480px) {
            body.iframe-mode .content-wrapper {
                padding: 70px 15px 20px;
            }
        }
        
        /* Ajax content styles */
        #ajaxContent {
            display: none;
        }
        
        body.ajax-mode #ajaxContent {
            display: block;
        }
        
        body.ajax-mode .content-frame {
            display: none !important;
        }
        
        /* Prevent sidebar scroll jump */
        .sidebar {
            scroll-behavior: auto; /* Disable smooth scrolling that might cause jumps */
        }
    </style>
</head>
<body>
    <!-- Mobile menu toggle -->
    <button class="mobile-menu-toggle" id="menuToggle" aria-label="Toggle menu">
        <span></span>
        <span></span>
        <span></span>
    </button>

    <!-- Sidebar Navigation -->
    <nav class="sidebar" id="sidebar">
        <div class="logo-container">
            <a href="#" onclick="loadPage('index'); return false;">
                <img src="logo.png" alt="Gocoin Logo" class="logo">
            </a>
            <h1 class="site-title">Gocoin</h1>
        </div>
        
        <ul class="nav-menu">
            <li><a href="#" onclick="loadPage('index'); return false;" data-page="index" class="nav-link active">About Gocoin</a></li>
            <li><a href="#" onclick="loadPage('news'); return false;" data-page="news" class="nav-link">Latest News</a></li>
            <li><a href="#" onclick="loadPage('installation'); return false;" data-page="installation" class="nav-link">Installation</a></li>
            <li class="nav-section">
                <span class="section-title">User Manual</span>
                <ul class="sub-menu">
                    <li><a href="#" onclick="loadPage('manual_client'); return false;" data-page="manual_client" class="nav-link">Client Node</a></li>
                    <li><a href="#" onclick="loadPage('manual_config'); return false;" data-page="manual_config" class="nav-link">Config File</a></li>
                    <li><a href="#" onclick="loadPage('manual_wallet'); return false;" data-page="manual_wallet" class="nav-link">Setup Wallet</a></li>
                    <li><a href="#" onclick="loadPage('manual_spending'); return false;" data-page="manual_spending" class="nav-link">Spending BTC</a></li>
                    <li><a href="#" onclick="loadPage('manual_multisig'); return false;" data-page="manual_multisig" class="nav-link">Multi-signature</a></li>
                </ul>
            </li>
            <li><a href="#" onclick="loadPage('performance'); return false;" data-page="performance" class="nav-link">Performance</a></li>
            <li><a href="#" onclick="loadPage('tweaks'); return false;" data-page="tweaks" class="nav-link">Tweaks</a></li>
            <li><a href="#" onclick="loadPage('issues'); return false;" data-page="issues" class="nav-link">Known Issues</a></li>
            <li><a href="#" onclick="loadPage('links'); return false;" data-page="links" class="nav-link">Links / Contact</a></li>
        </ul>
    </nav>

    <!-- Main Content Area -->
    <main class="main-content" id="mainContent">
        <div class="content-wrapper" id="contentWrapper">
            <!-- Iframes for local viewing -->
            <iframe class="content-frame active" id="frame-index" src="gocoin_index.html"></iframe>
            <iframe class="content-frame" id="frame-news"></iframe>
            <iframe class="content-frame" id="frame-installation"></iframe>
            <iframe class="content-frame" id="frame-manual_client"></iframe>
            <iframe class="content-frame" id="frame-manual_config"></iframe>
            <iframe class="content-frame" id="frame-manual_wallet"></iframe>
            <iframe class="content-frame" id="frame-manual_spending"></iframe>
            <iframe class="content-frame" id="frame-manual_multisig"></iframe>
            <iframe class="content-frame" id="frame-performance"></iframe>
            <iframe class="content-frame" id="frame-tweaks"></iframe>
            <iframe class="content-frame" id="frame-issues"></iframe>
            <iframe class="content-frame" id="frame-links"></iframe>
            
            <!-- Ajax content container (for server mode) -->
            <div id="ajaxContent">
                <div class="loading">Loading...</div>
            </div>
        </div>
    </main>

    <script>
        // Detect if we're running on a server or locally
        const isLocal = window.location.protocol === 'file:';
        let currentPage = 'index';
        let sidebarScrollPosition = 0;

        // Initialize on page load
        document.addEventListener('DOMContentLoaded', function() {
            // Set mode
            if (isLocal) {
                document.body.classList.add('iframe-mode');
                console.log('Running in local mode (iframes)');
                
                // Inject white background into initial iframe
                const initialFrame = document.getElementById('frame-index');
                if (initialFrame) {
                    initialFrame.onload = function() {
                        try {
                            const iframeDoc = initialFrame.contentDocument || initialFrame.contentWindow.document;
                            const style = iframeDoc.createElement('style');
                            style.textContent = 'body { background: white !important; }';
                            iframeDoc.head.appendChild(style);
                        } catch(e) {
                            console.log('Could not inject style into initial iframe:', e);
                        }
                    };
                    // Trigger if already loaded
                    if (initialFrame.contentDocument && initialFrame.contentDocument.readyState === 'complete') {
                        initialFrame.onload();
                    }
                }
            } else {
                document.body.classList.add('ajax-mode');
                console.log('Running in server mode (AJAX)');
                
                // Load initial page from URL if on server
                const urlPage = getPageFromURL();
                if (urlPage && urlPage !== 'index') {
                    loadPage(urlPage);
                } else {
                    loadPage('index');
                }
            }
            
            initMobileMenu();
            
            // Track sidebar scroll position
            const sidebar = document.getElementById('sidebar');
            if (sidebar) {
                sidebar.addEventListener('scroll', function() {
                    sidebarScrollPosition = sidebar.scrollTop;
                });
            }
        });

        // Get page name from URL (for server mode)
        function getPageFromURL() {
            const urlParams = new URLSearchParams(window.location.search);
            const pageParam = urlParams.get('id');
            if (pageParam) return pageParam;
            
            const path = window.location.pathname;
            const match = path.match(/\/([a-zA-Z_]+)\/?$/);
            if (match && match[1] !== 'page' && match[1] !== 'index.html') {
                return match[1];
            }
            
            return '';
        }

        // Load page - works in both modes
        function loadPage(pageName) {
            if (!pageName) pageName = 'index';
            currentPage = pageName;
            
            console.log('Loading page:', pageName);
            
            // Save current sidebar scroll position
            const sidebar = document.getElementById('sidebar');
            if (sidebar) {
                sidebarScrollPosition = sidebar.scrollTop;
            }
            
            // Update active menu state
            const navLinks = document.querySelectorAll('.nav-link');
            navLinks.forEach(link => {
                if (link.getAttribute('data-page') === pageName) {
                    link.classList.add('active');
                } else {
                    link.classList.remove('active');
                }
            });
            
            if (isLocal) {
                // Local mode: Use iframes
                loadPageIframe(pageName);
            } else {
                // Server mode: Use AJAX
                loadPageAjax(pageName);
            }
            
            // Restore sidebar scroll position after a brief delay
            setTimeout(function() {
                if (sidebar) {
                    sidebar.scrollTop = sidebarScrollPosition;
                }
            }, 50);
            
            // Close mobile menu if open
            closeMobileMenu();
            
            return false;
        }

        // Load page using iframe (local mode)
        function loadPageIframe(pageName) {
            const frames = document.querySelectorAll('.content-frame');
            frames.forEach(frame => {
                frame.classList.remove('active');
            });
            
            const targetFrame = document.getElementById('frame-' + pageName);
            if (targetFrame) {
                // Load iframe if not yet loaded
                if (!targetFrame.src || targetFrame.src === '' || targetFrame.src === window.location.href) {
                    targetFrame.src = 'gocoin_' + pageName + '.html';
                    
                    // Inject white background style when iframe loads
                    targetFrame.onload = function() {
                        try {
                            const iframeDoc = targetFrame.contentDocument || targetFrame.contentWindow.document;
                            const style = iframeDoc.createElement('style');
                            style.textContent = 'body { background: white !important; }';
                            iframeDoc.head.appendChild(style);
                        } catch(e) {
                            console.log('Could not inject style into iframe:', e);
                        }
                    };
                }
                targetFrame.classList.add('active');
            }
        }

        // Load page using AJAX (server mode)
        function loadPageAjax(pageName) {
            const contentDiv = document.getElementById('ajaxContent');
            const sidebar = document.getElementById('sidebar');
            
            // Save scroll position before loading
            const savedScrollPosition = sidebar ? sidebar.scrollTop : 0;
            
            contentDiv.innerHTML = '<div class="loading">Loading...</div>';
            contentDiv.style.opacity = '0.5';
            
            const filename = 'gocoin_' + pageName + '.html';
            
            // Use XMLHttpRequest for better compatibility
            const xhr = new XMLHttpRequest();
            xhr.open('GET', filename, true);
            
            xhr.onload = function() {
                if (xhr.status === 200) {
                    // Extract body content
                    const parser = new DOMParser();
                    const doc = parser.parseFromString(xhr.responseText, 'text/html');
                    const body = doc.querySelector('body');
                    
                    if (body) {
                        contentDiv.innerHTML = body.innerHTML;
                        contentDiv.style.opacity = '1';
                        
                        // Update external links
                        setTimeout(updateExternalLinks, 100);
                        
                        // Restore sidebar scroll position
                        if (sidebar) {
                            sidebar.scrollTop = savedScrollPosition;
                        }
                        
                        // Update URL without reload
                        if (window.history && window.history.pushState) {
                            window.history.pushState({page: pageName}, '', pageName);
                        }
                        
                        // Scroll main content to top (not sidebar!)
                        const mainContent = document.getElementById('mainContent');
                        if (mainContent) {
                            mainContent.scrollTop = 0;
                        }
                    }
                } else {
                    contentDiv.innerHTML = '<div style="padding: 40px;"><h2>Page Not Found</h2><p>Could not load the requested page.</p></div>';
                    contentDiv.style.opacity = '1';
                    
                    // Restore sidebar scroll position even on error
                    if (sidebar) {
                        sidebar.scrollTop = savedScrollPosition;
                    }
                }
            };
            
            xhr.onerror = function() {
                contentDiv.innerHTML = '<div style="padding: 40px;"><h2>Error</h2><p>Failed to load the page.</p></div>';
                contentDiv.style.opacity = '1';
                
                // Restore sidebar scroll position even on error
                if (sidebar) {
                    sidebar.scrollTop = savedScrollPosition;
                }
            };
            
            xhr.send();
        }

        // Update external links to open in new tabs
        function updateExternalLinks() {
            const links = document.querySelectorAll('#ajaxContent a');
            links.forEach(link => {
                const href = link.getAttribute('href');
                if (href && (href.startsWith('http://') || href.startsWith('https://'))) {
                    link.setAttribute('target', '_blank');
                    link.setAttribute('rel', 'noopener noreferrer');
                }
            });
        }

        // Mobile menu functionality
        function initMobileMenu() {
            const menuToggle = document.getElementById('menuToggle');
            const sidebar = document.getElementById('sidebar');
            const mainContent = document.getElementById('mainContent');
            
            if (menuToggle) {
                menuToggle.addEventListener('click', function() {
                    this.classList.toggle('active');
                    sidebar.classList.toggle('active');
                });
            }
            
            if (mainContent) {
                mainContent.addEventListener('click', function(e) {
                    // Don't close if clicking on content links
                    if (e.target.tagName !== 'A' && sidebar.classList.contains('active')) {
                        closeMobileMenu();
                    }
                });
            }
        }

        function closeMobileMenu() {
            const menuToggle = document.getElementById('menuToggle');
            const sidebar = document.getElementById('sidebar');
            
            if (menuToggle) menuToggle.classList.remove('active');
            if (sidebar) sidebar.classList.remove('active');
        }

        // Handle browser back/forward buttons (server mode only)
        if (!isLocal) {
            window.addEventListener('popstate', function(e) {
                const page = getPageFromURL() || 'index';
                loadPage(page);
            });
        }
        
        // Listen for messages from iframes (for navigation)
        window.addEventListener('message', function(e) {
            if (e.data && e.data.action === 'loadPage' && e.data.page) {
                loadPage(e.data.page);
            }
        });
    </script>
</body>
</html>
